<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>HTMX/Rust Todo</title>
  </head>
  <body>
    <h1>My Todos</h1>
    <div>
      |--TODOS PLACEHOLDER--|
    </div>
    <input type="text" />
    <button type="submit" id="create-btn">Create New Todo</button>
    <script>
      const input = document.querySelector("input");
      const create_btn = document.getElementById("create-btn");
      const div = document.querySelector("div");

      const hydrate_buttons = () => {
        const del_btns = document.querySelectorAll('.del-btn');

        for (let del_btn of del_btns) {
          const id = Number(del_btn.getAttribute('data-todo-id'));
          del_btn.addEventListener("click", () => {
            delete_todo(id);
          });
        }
      }
      
      const create_new_todo = async () => {
        console.log("Attempting to create new todo:", input.value);
        if (input.value === '') {
          alert("Please enter a todo.");
          return;
        }

        const fd = new FormData();

        fd.set("todo", input.value);

        try {
          const response = await fetch("http://127.0.0.1:3000/create", {
            method: "POST",
            body: fd
          });
          const text = await response.text();
          div.innerHTML = text;

          console.log("Replaced HTML");
        } catch(e) {
          console.error(e);
        }

        hydrate_buttons();

        input.value = "";

        console.log("Created new todo:", input.value)
      }

      create_btn.addEventListener("click", create_new_todo);
      input.addEventListener("keydown", evt => {
        if (evt.code === "Enter") create_new_todo();
      });

      const delete_todo = async (id) => {
        const fd = new FormData();

        fd.set("todo-id", id);

        try {
          const response = await fetch("http://127.0.0.1:3000/delete", {
            method: "DELETE",
            body: fd
          });
          const text = await response.text();
          div.innerHTML = text;

          console.log("Replaced HTML");
        } catch(e) {
          console.error(e);
        }

        hydrate_buttons();
      }

      hydrate_buttons();
    </script>
  </body>
</html>